generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = "postgresql://postgres.jsismwafswmoqwfbfswv:dola%40sohom123%23@aws-1-ap-south-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
  directUrl = "postgresql://postgres.jsismwafswmoqwfbfswv:dola%40sohom123%23@aws-1-ap-south-1.pooler.supabase.com:5432/postgres"
  schemas   = ["auth", "public"]
}

// Map to existing 'users' table in public schema
model User {
  walletAddress  String           @id @map("walletAddress") // Check column name - db pull said 'walletAddress' in Step 368?
  kycStatus      KycStatus        @default(PENDING)
  createdAt      DateTime         @default(now())
  
  transactions   Transaction[]
  onRampIntents  OnRampIntent[]
  offRampIntents OffRampIntent[]
  stockPositions StockPosition[]
  telegramLink   TelegramLink?
  
  @@map("users")
  @@schema("public")
}

// Map to 'auth_nonces'
model AuthNonce {
  id            String   @id @default(uuid())
  walletAddress String   @unique @map("walletAddress") // db pull said 'walletAddress'
  nonce         String
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  
  @@index([walletAddress])
  @@index([nonce])
  @@map("auth_nonces")
  @@schema("public")
}

model Transaction {
  id            String          @id @default(uuid())
  walletAddress String
  txHash        String          @unique
  fromAddress   String
  toAddress     String
  amount        String
  assetCode     String          @default("XLM")
  assetIssuer   String?
  type          TransactionType
  status        TxStatus        @default(PENDING)
  memo          String?
  ledger        Int?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  user          User            @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([txHash])
  @@map("transactions")
  @@schema("public")
}

model OnRampIntent {
  id              String     @id @default(uuid())
  walletAddress   String
  inrAmount       Float
  cryptoAmount    Float?
  asset           String     @default("XLM")
  exchangeRate    Float?
  status          RampStatus @default(PENDING)
  paymentRef      String?
  txHash          String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  completedAt     DateTime?
  
  user            User       @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([status])
  @@map("onramp_intents")
  @@schema("public")
}

model OffRampIntent {
  id              String     @id @default(uuid())
  walletAddress   String
  cryptoAmount    Float
  inrAmount       Float?
  asset           String     @default("XLM")
  exchangeRate    Float?
  bankAccountNo   String?
  bankIfsc        String?
  upiId           String?
  status          RampStatus @default(PENDING)
  lockTxHash      String?
  payoutRef       String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  completedAt     DateTime?
  
  user            User       @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([status])
  @@map("offramp_intents")
  @@schema("public")
}

model StockPosition {
  id            String   @id @default(uuid())
  walletAddress String
  symbol        String
  name          String?
  units         Float
  entryPrice    Float
  currentPrice  Float?
  txHash        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [walletAddress], references: [walletAddress])
  
  @@unique([walletAddress, symbol])
  @@index([walletAddress])
  @@map("stock_positions")
  @@schema("public")
}

model TelegramLink {
  id             String   @id @default(uuid())
  walletAddress  String   @unique
  telegramUserId String
  telegramChat   String?
  linkedAt       DateTime @default(now())
  
  user           User     @relation(fields: [walletAddress], references: [walletAddress])
  
  @@map("telegram_links")
  @@schema("public")
}

model EscrowPosition {
  id                String       @id @default(uuid())
  loanId            Int          @unique
  borrowerAddress   String
  lenderAddress     String
  collateralToken   String
  collateralAmount  String
  loanAmount        String
  durationSeconds   Int
  status            EscrowStatus @default(PENDING)
  lockTxHash        String?
  releaseTxHash     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@index([borrowerAddress])
  @@index([lenderAddress])
  @@map("escrow_positions")
  @@schema("public")
}

enum KycStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  @@schema("public")
}

enum TransactionType {
  PAYMENT
  RECEIVED
  ESCROW_LOCK
  ESCROW_RELEASE
  ON_RAMP
  OFF_RAMP
  STOCK_BUY
  STOCK_SELL
  @@schema("public")
}

enum TxStatus {
  PENDING
  SUCCESS
  FAILED
  @@schema("public")
}

enum RampStatus {
  PENDING
  INR_CONFIRMED
  CRYPTO_LOCKED
  CRYPTO_SENT
  INR_SENT
  COMPLETED
  FAILED
  CANCELLED
  @@schema("public")
}

enum EscrowStatus {
  PENDING
  LOCKED
  RELEASED
  LIQUIDATED
  CANCELLED
  @@schema("public")
}
