// Prisma Schema - LumenPay (Master PRD)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = "postgresql://postgres.jsismwafswmoqwfbfswv:dola%40sohom123%23@aws-1-ap-south-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
  directUrl = "postgresql://postgres.jsismwafswmoqwfbfswv:dola%40sohom123%23@aws-1-ap-south-1.pooler.supabase.com:5432/postgres"
}

// 1. USER & IDENTITY
model User {
  walletAddress  String           @id
  kycStatus      KycStatus        @default(PENDING)
  kycSessionId   String?
  createdAt      DateTime         @default(now())
  
  // Relations
  transactions   UnifiedTransaction[]
  offchainBalances OffchainBalance[]
  onRampIntents  OnRampIntent[]
  offRampIntents OffRampIntent[]
  stockPositions StockPosition[]
  telegramLink   TelegramLink?
  
  @@map("users")
}

// 2. OFF-CHAIN LEDGER
model OffchainBalance {
  id            String   @id @default(uuid())
  walletAddress String
  asset         String   @default("USDC") 
  balance       Float    @default(0.0)
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [walletAddress], references: [walletAddress])

  @@unique([walletAddress, asset])
  @@map("offchain_balances")
}

// 3. UNIFIED TRANSACTION (On-chain + Off-chain)
model UnifiedTransaction {
  id            String          @id @default(uuid())
  walletAddress String
  ledger        LedgerType
  type          TxType
  asset         String
  amount        Float
  txHash        String?         // Null for internal off-chain txs until settled
  status        TxStatus        @default(PENDING)
  createdAt     DateTime        @default(now())
  
  // Metadata
  fromAddress   String?
  toAddress     String?
  memo          String?

  user          User            @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([txHash])
  @@map("unified_transactions")
}

// 4. AUTHENTICATION (Wallet Nonces)
model AuthNonce {
  id            String   @id @default(uuid())
  walletAddress String
  nonce         String
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  
  @@index([walletAddress])
  @@index([nonce])
  @@map("auth_nonces")
}

// 5. ON-RAMP (INR -> Crypto)
model OnRampIntent {
  id              String     @id @default(uuid())
  walletAddress   String
  inrAmount       Float
  cryptoAmount    Float?
  asset           String     @default("XLM")
  exchangeRate    Float?
  status          RampStatus @default(PENDING)
  paymentRef      String?
  txHash          String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  completedAt     DateTime?
  
  user            User       @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([status])
  @@map("onramp_intents")
}

// 6. OFF-RAMP (Crypto -> INR)
model OffRampIntent {
  id              String     @id @default(uuid())
  walletAddress   String
  cryptoAmount    Float
  inrAmount       Float?
  asset           String     @default("XLM")
  exchangeRate    Float?
  bankAccountNo   String?
  bankIfsc        String?
  upiId           String?
  status          RampStatus @default(PENDING)
  lockTxHash      String?
  payoutRef       String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  completedAt     DateTime?
  
  user            User       @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([status])
  @@map("offramp_intents")
}

// 7. RWA / STOCKS
model StockPosition {
  id            String   @id @default(uuid())
  walletAddress String
  symbol        String
  name          String?
  units         Float
  entryPrice    Float
  currentPrice  Float?
  txHash        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [walletAddress], references: [walletAddress])
  
  @@unique([walletAddress, symbol])
  @@index([walletAddress])
  @@map("stock_positions")
}

// 8. TELEGRAM
model TelegramLink {
  id             String   @id @default(uuid())
  walletAddress  String   @unique
  telegramUserId String
  telegramChat   String?
  linkedAt       DateTime @default(now())
  
  user           User     @relation(fields: [walletAddress], references: [walletAddress])
  
  @@map("telegram_links")
}

// 9. ESCROW (Soroban)
model EscrowPosition {
  id                String       @id @default(uuid())
  loanId            Int          @unique
  borrowerAddress   String
  lenderAddress     String
  collateralToken   String
  collateralAmount  String
  loanAmount        String
  durationSeconds   Int
  status            EscrowStatus @default(PENDING)
  lockTxHash        String?
  releaseTxHash     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@index([borrowerAddress])
  @@index([lenderAddress])
  @@map("escrow_positions")
}

// ENUMS
enum LedgerType {
  ON_CHAIN
  OFF_CHAIN
  HYBRID
}

enum KycStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
}

enum TxType {
  PAYMENT
  RECEIVED
  ESCROW_LOCK
  ESCROW_RELEASE
  ON_RAMP
  OFF_RAMP
  STOCK_BUY
  STOCK_SELL
}

enum TxStatus {
  PENDING
  SUCCESS
  FAILED
}

enum RampStatus {
  PENDING
  INR_CONFIRMED
  CRYPTO_LOCKED
  CRYPTO_SENT
  INR_SENT
  COMPLETED
  FAILED
  CANCELLED
}

enum EscrowStatus {
  PENDING
  LOCKED
  RELEASED
  LIQUIDATED
  CANCELLED
}
