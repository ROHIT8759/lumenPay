generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  relationMode = "prisma"
}

model User {
  walletAddress   String               @id
  createdAt       DateTime             @default(now())
  kycStatus       KycStatus            @default(PENDING)

  balances        OffchainBalance[]
  transactions    UnifiedTransaction[]
  onRampIntents   OnRampIntent[]
  offRampIntents  OffRampIntent[]
  stockPositions  StockPosition[]
  telegramLink    TelegramLink?
  kycRecord       KycRecord?

  @@map("users")
}

model AuthNonce {
  walletAddress String
  nonce         String
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  @@id([walletAddress, nonce])
  @@index([expiresAt])
  @@map("auth_nonces")
}

model OffchainBalance {
  walletAddress String
  asset         String
  balance       Float    @default(0)
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [walletAddress], references: [walletAddress])

  @@id([walletAddress, asset])
  @@map("offchain_balances")
}

model UnifiedTransaction {
  id            String     @id @default(uuid())
  walletAddress String
  ledger        LedgerType
  type          TxType
  asset         String
  amount        Float
  txHash        String?
  status        TxStatus
  fromAddress   String?
  toAddress     String?
  memo          String?
  createdAt     DateTime   @default(now())

  user          User       @relation(fields: [walletAddress], references: [walletAddress])

  @@unique([walletAddress, txHash])
  @@index([walletAddress])
  @@index([txHash])
  @@map("unified_transactions")
}

model KycRecord {
  walletAddress String     @id
  provider      String
  status        KycStatus  @default(PENDING)
  providerRef   String?
  verifiedAt    DateTime?
  updatedAt     DateTime   @updatedAt

  user          User       @relation(fields: [walletAddress], references: [walletAddress])

  @@map("kyc_records")
}

model TelegramLink {
  walletAddress  String   @id
  chatId         String
  telegramUserId String?
  linkedAt       DateTime @default(now())

  user           User     @relation(fields: [walletAddress], references: [walletAddress])

  @@map("telegram_links")
}

model OnRampIntent {
  id              String     @id @default(uuid())
  walletAddress   String
  inrAmount       Float
  cryptoAmount    Float?
  asset           String     @default("XLM")
  exchangeRate    Float?
  status          RampStatus @default(PENDING)
  paymentRef      String?
  txHash          String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  completedAt     DateTime?
  
  user            User       @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([status])
  @@map("onramp_intents")
}

model OffRampIntent {
  id              String     @id @default(uuid())
  walletAddress   String
  cryptoAmount    Float
  inrAmount       Float?
  asset           String     @default("XLM")
  exchangeRate    Float?
  bankAccountNo   String?
  bankIfsc        String?
  upiId           String?
  status          RampStatus @default(PENDING)
  lockTxHash      String?
  payoutRef       String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  completedAt     DateTime?
  
  user            User       @relation(fields: [walletAddress], references: [walletAddress])
  
  @@index([walletAddress])
  @@index([status])
  @@map("offramp_intents")
}

model StockPosition {
  id            String   @id @default(uuid())
  walletAddress String
  symbol        String
  name          String?
  units         Float
  entryPrice    Float
  currentPrice  Float?
  txHash        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [walletAddress], references: [walletAddress])
  
  @@unique([walletAddress, symbol])
  @@index([walletAddress])
  @@map("stock_positions")
}

model EscrowPosition {
  id                String       @id @default(uuid())
  loanId            Int          @unique
  borrowerAddress   String
  lenderAddress     String
  collateralToken   String
  collateralAmount  String
  loanAmount        String
  durationSeconds   Int
  status            EscrowStatus @default(PENDING)
  lockTxHash        String?
  releaseTxHash     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@index([borrowerAddress])
  @@index([lenderAddress])
  @@map("escrow_positions")
}

enum KycStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
}

enum LedgerType {
  ONCHAIN
  OFFCHAIN
  HYBRID
}

enum TxType {
  PAYMENT
  ESCROW
  ONRAMP
  OFFRAMP
  STOCK
}

enum TxStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum RampStatus {
  PENDING
  INR_CONFIRMED
  CRYPTO_LOCKED
  CRYPTO_SENT
  INR_SENT
  COMPLETED
  FAILED
  CANCELLED
}

enum EscrowStatus {
  PENDING
  LOCKED
  RELEASED
  LIQUIDATED
  CANCELLED
}

model IndexerState {
  id                Int      @id @default(autoincrement())
  lastHorizonCursor String
  lastSorobanLedger Int
  updatedAt         DateTime @updatedAt
  
  @@map("indexer_state")
}

// ============================================================
// Loan Models
// ============================================================

model Loan {
  id                  String          @id @default(uuid())
  walletAddress       String
  loanType            LoanType        @default(COLLATERAL)
  principalAmount     Float
  loanAmount          Float
  interestRateBps     Int             // Basis points (10000 = 100%)
  tenureDays          Int
  amountRepaid        Float           @default(0)
  amountOutstanding   Float
  interestAccrued     Float           @default(0)
  status              LoanStatus      @default(PENDING)
  ltvRatio            Float?
  liquidationThreshold Float          @default(80)
  dueDate             DateTime?
  disbursedAt         DateTime?
  repaidAt            DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  collateral          LoanCollateral[]
  
  @@index([walletAddress])
  @@index([status])
  @@map("loans")
}

model LoanCollateral {
  id              String          @id @default(uuid())
  loanId          String
  walletAddress   String
  collateralType  CollateralType
  assetCode       String
  amount          Float
  valueAtDeposit  Float
  currentValue    Float?
  isLocked        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  loan            Loan            @relation(fields: [loanId], references: [id])
  
  @@index([loanId])
  @@index([walletAddress])
  @@map("loan_collateral")
}

enum LoanType {
  COLLATERAL
  FLASH
}

enum LoanStatus {
  PENDING
  ACTIVE
  REPAID
  DEFAULTED
  LIQUIDATED
  CANCELLED
}

enum CollateralType {
  USDC
  XLM
  RWA
}

// ============================================================
// RWA Models
// ============================================================

model RwaAsset {
  id                  String          @id @default(uuid())
  assetCode           String          @unique
  issuerAddress       String
  assetType           RwaAssetType
  name                String
  description         String?
  detailedInfo        Json?
  imageUrl            String?
  documentUrls        String[]
  unitPrice           Float
  totalSupply         Float
  availableSupply     Float
  minInvestment       Float           @default(0)
  maxInvestment       Float?
  yieldType           YieldType       @default(NONE)
  annualYieldPercent  Float           @default(0)
  yieldFrequency      YieldFrequency  @default(NONE)
  riskLevel           RiskLevel       @default(MEDIUM)
  requiresKyc         Boolean         @default(false)
  minKycLevel         Int             @default(0)
  accreditedOnly      Boolean         @default(false)
  status              AssetStatus     @default(PENDING)
  isFeatured          Boolean         @default(false)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  holdings            RwaHolding[]
  purchases           RwaPurchase[]
  
  @@index([assetType])
  @@index([status])
  @@map("rwa_assets")
}

model RwaHolding {
  id                  String      @id @default(uuid())
  walletAddress       String
  assetId             String
  quantity            Float
  averageBuyPrice     Float
  totalInvested       Float
  totalYieldEarned    Float       @default(0)
  pendingYield        Float       @default(0)
  trustlineEstablished Boolean    @default(false)
  firstPurchaseAt     DateTime    @default(now())
  lastTransactionAt   DateTime    @default(now())
  
  asset               RwaAsset    @relation(fields: [assetId], references: [id])
  
  @@unique([walletAddress, assetId])
  @@index([walletAddress])
  @@map("rwa_holdings")
}

model RwaPurchase {
  id              String          @id @default(uuid())
  walletAddress   String
  assetId         String
  quantity        Float
  pricePerUnit    Float
  totalCost       Float
  paymentAsset    String          @default("USDC")
  txHash          String?
  status          PurchaseStatus  @default(PENDING)
  createdAt       DateTime        @default(now())
  completedAt     DateTime?
  
  asset           RwaAsset        @relation(fields: [assetId], references: [id])
  
  @@index([walletAddress])
  @@index([status])
  @@map("rwa_purchases")
}

enum RwaAssetType {
  REAL_ESTATE
  BOND
  COMMODITY
  INVOICE
  STABLE_YIELD
  EQUITY_TOKEN
}

enum YieldType {
  FIXED
  VARIABLE
  NONE
}

enum YieldFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
  NONE
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum AssetStatus {
  ACTIVE
  PAUSED
  RETIRED
  PENDING
}

enum PurchaseStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}

