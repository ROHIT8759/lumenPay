/**
 * LumenVault Wallet Setup Screen
 * 
 * This screen generates a new Stellar keypair on the DEVICE and stores it
 * securely in SecureStore. The private key NEVER leaves the device.
 * 
 * Flow:
 * 1. User taps "Create One-Tap Wallet"
 * 2. Generate Stellar keypair locally
 * 3. Store encrypted in SecureStore
 * 4. Fund account via Friendbot (testnet)
 * 5. Navigate to home
 */

import React, { useState } from 'react';
import { View, Text, TouchableOpacity, Dimensions, Alert } from 'react-native';
import Animated, {
    useSharedValue,
    useAnimatedStyle,
    withSpring,
    withTiming,
    withRepeat,
    Easing,
    runOnJS
} from 'react-native-reanimated';
import { useRouter } from 'expo-router';
import { Check, Key, Shield } from 'lucide-react-native';
import { createWallet, loadWallet } from '../lib/stellar';

const { width } = Dimensions.get('window');

type SetupStatus = 'idle' | 'generating' | 'funding' | 'success' | 'error';

export default function WalletSetup() {
    const router = useRouter();
    const [status, setStatus] = useState<SetupStatus>('idle');
    const [publicKey, setPublicKey] = useState<string>('');
    const [errorMessage, setErrorMessage] = useState<string>('');

    // Animation values
    const spin = useSharedValue(0);
    const scale = useSharedValue(1);
    const lockOpacity = useSharedValue(0);
    const buttonOpacity = useSharedValue(1);
    const keyScale = useSharedValue(0);

    const handleCreate = async () => {
        setStatus('generating');
        buttonOpacity.value = withTiming(0, { duration: 300 });

        // Start spinner animation
        spin.value = withRepeat(
            withTiming(360, { duration: 1000, easing: Easing.linear }),
            -1, // Infinite
            false
        );

        try {
            // Check if wallet already exists
            const existingWallet = await loadWallet();
            if (existingWallet) {
                // Wallet already exists, just navigate
                handleSuccess(existingWallet.publicKey());
                return;
            }

            // Generate new wallet on device
            setStatus('generating');
            const wallet = await createWallet();

            setPublicKey(wallet.publicKey);

            // Wallet created and funded
            handleSuccess(wallet.publicKey);

        } catch (error: any) {
            console.error('Wallet creation failed:', error);
            setStatus('error');
            setErrorMessage(error.message || 'Failed to create wallet');
            spin.value = 0;
            buttonOpacity.value = withTiming(1, { duration: 300 });
        }
    };

    const handleSuccess = (pubKey: string) => {
        setStatus('success');
        setPublicKey(pubKey);

        // Stop spinner, show success
        spin.value = 0;
        scale.value = withSpring(1.2, { damping: 10 });
        lockOpacity.value = withTiming(1, { duration: 500 });
        keyScale.value = withSpring(1, { damping: 12 });

        // Navigate after celebration
        setTimeout(() => {
            router.replace('/(tabs)/home');
        }, 2000);
    };

    const handleRetry = () => {
        setStatus('idle');
        setErrorMessage('');
        buttonOpacity.value = withTiming(1, { duration: 300 });
    };

    const particleStyle = useAnimatedStyle(() => ({
        transform: [{ rotate: `${spin.value}deg` }, { scale: scale.value }]
    }));

    const lockStyle = useAnimatedStyle(() => ({
        opacity: lockOpacity.value,
        transform: [{ scale: lockOpacity.value }]
    }));

    const buttonStyle = useAnimatedStyle(() => ({
        opacity: buttonOpacity.value
    }));

    const keyStyle = useAnimatedStyle(() => ({
        opacity: keyScale.value,
        transform: [{ scale: keyScale.value }]
    }));

    const getStatusText = () => {
        switch (status) {
            case 'generating':
                return 'Generating secure keys...';
            case 'funding':
                return 'Funding your account...';
            case 'success':
                return 'Wallet Created!';
            case 'error':
                return 'Something went wrong';
            default:
                return '';
        }
    };

    return (
        <View className="flex-1 bg-primary items-center justify-center px-6">
            {/* Header */}
            <View className="items-center mb-12 space-y-4">
                <Text className="text-3xl font-bold text-white text-center">Your Money.</Text>
                <Text className="text-3xl font-bold text-accent text-center">Your Keys.</Text>
                <Text className="text-gray-400 text-center mt-4">
                    No emails. No passwords. Just you and the network.
                </Text>
            </View>

            {/* Animation Container */}
            <View className="h-40 w-40 items-center justify-center mb-8">
                {/* Spinner */}
                <Animated.View style={[particleStyle, { position: 'absolute' }]}>
                    <View className="w-32 h-32 border-4 border-accent/30 rounded-full border-t-accent" />
                </Animated.View>

                {/* Success Check */}
                <Animated.View style={[lockStyle]}>
                    <View className="w-20 h-20 bg-success rounded-full items-center justify-center shadow-lg shadow-success/50">
                        <Check size={40} color="white" />
                    </View>
                </Animated.View>
            </View>

            {/* Status Text */}
            {status !== 'idle' && (
                <View className="mb-4">
                    <Text className={`text-center text-lg ${status === 'error' ? 'text-red-400' : 'text-gray-300'}`}>
                        {getStatusText()}
                    </Text>
                    {status === 'error' && (
                        <Text className="text-center text-red-400 text-sm mt-2">
                            {errorMessage}
                        </Text>
                    )}
                </View>
            )}

            {/* Public Key Display (on success) */}
            {status === 'success' && publicKey && (
                <Animated.View style={keyStyle} className="mb-8 px-4">
                    <View className="bg-surface/50 rounded-xl p-4 border border-accent/20">
                        <View className="flex-row items-center gap-2 mb-2">
                            <Key size={16} color="#00E5FF" />
                            <Text className="text-accent text-sm font-medium">Your Public Key</Text>
                        </View>
                        <Text className="text-white font-mono text-xs" numberOfLines={2}>
                            {publicKey}
                        </Text>
                    </View>
                </Animated.View>
            )}

            {/* Security Badge */}
            <View className="flex-row items-center gap-2 mb-8 px-4 py-2 bg-success/10 rounded-full">
                <Shield size={16} color="#22C55E" />
                <Text className="text-success text-sm">Keys stored only on this device</Text>
            </View>

            {/* Action Button */}
            <Animated.View style={[buttonStyle, { width: '100%' }]}>
                {status === 'error' ? (
                    <TouchableOpacity
                        activeOpacity={0.8}
                        onPress={handleRetry}
                        className="w-full py-4 bg-red-500 rounded-2xl items-center shadow-lg"
                    >
                        <Text className="text-white font-bold text-lg">Try Again</Text>
                    </TouchableOpacity>
                ) : (
                    <TouchableOpacity
                        activeOpacity={0.8}
                        onPress={handleCreate}
                        disabled={status !== 'idle'}
                        className="w-full py-4 bg-white rounded-2xl items-center shadow-lg"
                    >
                        <Text className="text-primary font-bold text-lg">Create One-Tap Wallet</Text>
                    </TouchableOpacity>
                )}
                <Text className="text-gray-500 text-center mt-6 text-xs">
                    By creating a wallet, you agree to manage your own keys responsibly.
                </Text>
            </Animated.View>

            {/* Import Existing Option */}
            <TouchableOpacity
                className="mt-4"
                onPress={() => Alert.alert('Coming Soon', 'Import from secret key or mnemonic coming soon!')}
            >
                <Text className="text-accent text-sm">Already have a wallet? Import</Text>
            </TouchableOpacity>
        </View>
    );
}
