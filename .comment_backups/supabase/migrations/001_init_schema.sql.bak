-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================================================
-- USERS & AUTHENTICATION
-- ============================================================================

CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  phone TEXT UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  first_name TEXT,
  last_name TEXT,
  pay_id TEXT UNIQUE NOT NULL,
  avatar_url TEXT,
  bio TEXT,
  kyc_status INTEGER DEFAULT 0, -- 0: none, 1: basic, 2: full
  kyc_verified_at TIMESTAMP WITH TIME ZONE,
  daily_limit_stroops BIGINT DEFAULT 100000000, -- 10 XLM default
  total_spent_today BIGINT DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================================================
-- WALLETS & KEYS
-- ============================================================================

CREATE TABLE IF NOT EXISTS wallets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  public_key TEXT UNIQUE NOT NULL,
  encrypted_secret_key TEXT NOT NULL,
  encryption_iv TEXT NOT NULL,
  network TEXT DEFAULT 'testnet', -- testnet or public
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================================================
-- TRANSACTIONS
-- ============================================================================

CREATE TABLE IF NOT EXISTS transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  from_address TEXT NOT NULL,
  to_address TEXT NOT NULL,
  to_pay_id TEXT,
  amount BIGINT NOT NULL,
  asset_code TEXT DEFAULT 'XLM', -- XLM, USDC, etc
  status TEXT DEFAULT 'pending', -- pending, confirmed, failed
  stellar_tx_hash TEXT UNIQUE,
  memo TEXT,
  type TEXT, -- payment, loan_disbursement, loan_repayment, purchase
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  confirmed_at TIMESTAMP WITH TIME ZONE,
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at),
  INDEX idx_stellar_tx_hash (stellar_tx_hash)
);

-- ============================================================================
-- PEOPLE / TRANSACTION HISTORY
-- ============================================================================

CREATE TABLE IF NOT EXISTS people (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  contact_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  pay_id TEXT NOT NULL,
  public_key TEXT NOT NULL,
  last_transaction_at TIMESTAMP WITH TIME ZONE NOT NULL,
  transaction_count INTEGER DEFAULT 1,
  total_amount_stroops BIGINT DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, contact_id)
);

-- ============================================================================
-- LOANS
-- ============================================================================

CREATE TABLE IF NOT EXISTS loans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  borrower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  lender_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  loan_type TEXT NOT NULL, -- collateral_loan, flash_loan, personal_loan
  principal_stroops BIGINT NOT NULL,
  interest_rate_percent NUMERIC(5, 2) NOT NULL,
  tenure_days INTEGER,
  status TEXT DEFAULT 'pending', -- pending, disbursed, repaid, defaulted
  collateral_asset TEXT, -- XLM, USDC, etc
  collateral_amount BIGINT,
  soroban_contract_id TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  disbursed_at TIMESTAMP WITH TIME ZONE,
  repaid_at TIMESTAMP WITH TIME ZONE,
  INDEX idx_borrower (borrower_id),
  INDEX idx_lender (lender_id),
  INDEX idx_status (status)
);

-- ============================================================================
-- EMI SCHEDULES (Installments)
-- ============================================================================

CREATE TABLE IF NOT EXISTS emi_schedules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  loan_id UUID NOT NULL REFERENCES loans(id) ON DELETE CASCADE,
  emi_number INTEGER NOT NULL,
  due_date DATE NOT NULL,
  principal_due BIGINT NOT NULL,
  interest_due BIGINT NOT NULL,
  total_due BIGINT NOT NULL,
  paid_amount BIGINT DEFAULT 0,
  status TEXT DEFAULT 'pending', -- pending, paid, overdue, waived
  paid_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  INDEX idx_loan_id (loan_id),
  INDEX idx_due_date (due_date)
);

-- ============================================================================
-- KYC
-- ============================================================================

CREATE TABLE IF NOT EXISTS kyc_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  verification_level INTEGER DEFAULT 0, -- 0: none, 1: basic, 2: full
  status TEXT DEFAULT 'pending', -- pending, approved, rejected
  kyc_hash TEXT, -- Soroban on-chain hash
  submitted_at TIMESTAMP WITH TIME ZONE,
  verified_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================================================
-- RWA ASSETS (Real World Assets)
-- ============================================================================

CREATE TABLE IF NOT EXISTS rwa_assets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  price_stroops BIGINT NOT NULL,
  quantity_available INTEGER NOT NULL,
  image_url TEXT,
  category TEXT,
  kyc_required BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================================================
-- PURCHASES
-- ============================================================================

CREATE TABLE IF NOT EXISTS purchases (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  rwa_asset_id UUID NOT NULL REFERENCES rwa_assets(id),
  quantity INTEGER NOT NULL,
  total_price BIGINT NOT NULL,
  status TEXT DEFAULT 'pending', -- pending, completed, cancelled
  stellar_tx_hash TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  INDEX idx_user_id (user_id),
  INDEX idx_status (status)
);

-- ============================================================================
-- REWARDS & OFFERS
-- ============================================================================

CREATE TABLE IF NOT EXISTS rewards (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  reward_type TEXT NOT NULL, -- transaction_bonus, referral_bonus, activity_bonus
  amount BIGINT NOT NULL,
  status TEXT DEFAULT 'pending', -- pending, redeemed
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  redeemed_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE,
  INDEX idx_user_id (user_id),
  INDEX idx_status (status)
);

CREATE TABLE IF NOT EXISTS offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  description TEXT,
  discount_percent NUMERIC(5, 2),
  min_transaction_stroops BIGINT,
  max_uses INTEGER,
  current_uses INTEGER DEFAULT 0,
  active BOOLEAN DEFAULT true,
  start_date TIMESTAMP WITH TIME ZONE,
  end_date TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================================================
-- AUDIT LOG
-- ============================================================================

CREATE TABLE IF NOT EXISTS audit_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  action TEXT NOT NULL,
  resource_type TEXT,
  resource_id TEXT,
  details JSONB,
  ip_address TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at)
);

-- ============================================================================
-- ROW LEVEL SECURITY
-- ============================================================================

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE wallets ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE people ENABLE ROW LEVEL SECURITY;
ALTER TABLE loans ENABLE ROW LEVEL SECURITY;
ALTER TABLE kyc_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE rewards ENABLE ROW LEVEL SECURITY;

-- Profiles: Users can only see their own profile
CREATE POLICY "profiles_self_select" ON profiles
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

CREATE POLICY "profiles_self_update" ON profiles
  FOR UPDATE USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- Wallets: Users can only access their own wallet
CREATE POLICY "wallets_self_access" ON wallets
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- Transactions: Users can only see their own transactions
CREATE POLICY "transactions_self_select" ON transactions
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- People: Users can only see their own people list
CREATE POLICY "people_self_select" ON people
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- Loans: Users can see loans they're involved in
CREATE POLICY "loans_borrower_select" ON loans
  FOR SELECT USING (borrower_id = (SELECT id FROM users WHERE email = current_user));

CREATE POLICY "loans_lender_select" ON loans
  FOR SELECT USING (lender_id = (SELECT id FROM users WHERE email = current_user));

-- KYC: Users can only access their own KYC
CREATE POLICY "kyc_self_access" ON kyc_records
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- Purchases: Users can only see their own purchases
CREATE POLICY "purchases_self_select" ON purchases
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- Rewards: Users can only see their own rewards
CREATE POLICY "rewards_self_select" ON rewards
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- ============================================================================
-- FUNCTIONS
-- ============================================================================

-- Update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER profiles_update_timestamp
BEFORE UPDATE ON profiles
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER wallets_update_timestamp
BEFORE UPDATE ON wallets
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- Function to get user ID from email (for Supabase Auth integration)
CREATE OR REPLACE FUNCTION get_user_id_from_auth()
RETURNS UUID AS $$
BEGIN
  RETURN (SELECT id FROM users WHERE email = current_user);
END;
$$ LANGUAGE plpgsql;
