-- ============================================================================
-- QUICK ACTIONS EXTENSION SCHEMA
-- Migration 2: Assets, Trades, and Bank Payouts
-- ============================================================================

-- ============================================================================
-- CRYPTO ASSETS (Top 40)
-- ============================================================================

CREATE TABLE IF NOT EXISTS crypto_assets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  symbol TEXT UNIQUE NOT NULL,      -- BTC, ETH, SOL, etc
  name TEXT NOT NULL,                -- Bitcoin, Ethereum, Solana
  price_usd NUMERIC(20, 8) NOT NULL, -- Current USD price
  price_updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  market_cap_rank INTEGER,
  percent_change_24h NUMERIC(10, 4), -- 24h change percentage
  icon_url TEXT,                      -- Icon/logo URL
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  INDEX idx_symbol (symbol),
  INDEX idx_market_cap_rank (market_cap_rank)
);

-- ============================================================================
-- USER ASSET BALANCES (Holdings)
-- ============================================================================

CREATE TABLE IF NOT EXISTS asset_balances (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  asset_id UUID NOT NULL REFERENCES crypto_assets(id) ON DELETE CASCADE,
  balance NUMERIC(30, 8) NOT NULL DEFAULT 0, -- Holdings in asset
  locked_balance NUMERIC(30, 8) NOT NULL DEFAULT 0, -- In pending orders
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, asset_id),
  INDEX idx_user_id (user_id),
  INDEX idx_asset_id (asset_id)
);

-- ============================================================================
-- TRADES (Buy/Sell History)
-- ============================================================================

CREATE TABLE IF NOT EXISTS trades (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  asset_id UUID NOT NULL REFERENCES crypto_assets(id) ON DELETE CASCADE,
  type TEXT NOT NULL, -- 'buy' or 'sell'
  quantity NUMERIC(30, 8) NOT NULL,
  price_usd NUMERIC(20, 8) NOT NULL, -- Price per unit at trade time
  total_usd NUMERIC(30, 8) NOT NULL, -- quantity * price_usd
  usdc_debited BIGINT NOT NULL,      -- Amount debited from wallet (in stroops)
  status TEXT DEFAULT 'pending',     -- pending, executed, failed, cancelled
  stellar_tx_hash TEXT UNIQUE,
  order_id TEXT UNIQUE,
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  executed_at TIMESTAMP WITH TIME ZONE,
  INDEX idx_user_id (user_id),
  INDEX idx_asset_id (asset_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
);

-- ============================================================================
-- BANK PAYOUTS (Web2 Bridge)
-- ============================================================================

CREATE TABLE IF NOT EXISTS bank_payouts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  recipient_name TEXT NOT NULL,
  bank_identifier TEXT NOT NULL,      -- UPI ID, Account number, etc
  amount_usdc BIGINT NOT NULL,        -- Amount in stroops (USDC)
  bank_identifier_type TEXT,          -- 'upi_id', 'iban', 'account_number'
  status TEXT DEFAULT 'pending',      -- pending, processing, completed, failed
  reference_id TEXT UNIQUE,           -- Bank reference number
  error_message TEXT,
  completed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_reference_id (reference_id)
);

-- ============================================================================
-- QR SCAN HISTORY
-- ============================================================================

CREATE TABLE IF NOT EXISTS qr_scans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  scanned_data TEXT NOT NULL,        -- The raw QR data
  scanned_type TEXT,                 -- 'wallet_address' or 'pay_id'
  recipient_address TEXT,
  recipient_pay_id TEXT,
  amount BIGINT,
  status TEXT DEFAULT 'pending',     -- pending, transaction_completed, expired
  stellar_tx_hash TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expired_at TIMESTAMP WITH TIME ZONE,
  INDEX idx_user_id (user_id),
  INDEX idx_status (status)
);

-- ============================================================================
-- RATE LIMITING (Quick Actions)
-- ============================================================================

CREATE TABLE IF NOT EXISTS rate_limits (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  action_type TEXT NOT NULL,         -- 'scan_qr', 'pay_id', 'bank_payout', 'trade'
  count INTEGER DEFAULT 1,
  window_start TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  window_end TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  INDEX idx_user_action (user_id, action_type),
  INDEX idx_window (window_start, window_end)
);

-- ============================================================================
-- ROW LEVEL SECURITY
-- ============================================================================

ALTER TABLE asset_balances ENABLE ROW LEVEL SECURITY;
ALTER TABLE trades ENABLE ROW LEVEL SECURITY;
ALTER TABLE bank_payouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE qr_scans ENABLE ROW LEVEL SECURITY;

-- Asset Balances: Users can only see their own
CREATE POLICY "asset_balances_self_select" ON asset_balances
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- Trades: Users can only see their own
CREATE POLICY "trades_self_select" ON trades
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- Bank Payouts: Users can only see their own
CREATE POLICY "bank_payouts_self_select" ON bank_payouts
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- QR Scans: Users can only see their own
CREATE POLICY "qr_scans_self_select" ON qr_scans
  FOR SELECT USING (user_id = (SELECT id FROM users WHERE email = current_user));

-- ============================================================================
-- FUNCTIONS
-- ============================================================================

-- Update timestamps for assets
CREATE TRIGGER crypto_assets_update_timestamp
BEFORE UPDATE ON crypto_assets
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- Update timestamps for asset_balances
CREATE TRIGGER asset_balances_update_timestamp
BEFORE UPDATE ON asset_balances
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- Update timestamps for bank_payouts
CREATE TRIGGER bank_payouts_update_timestamp
BEFORE UPDATE ON bank_payouts
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- ============================================================================
-- SEED DATA: Top 40 Crypto Assets (Real market data structure)
-- ============================================================================

INSERT INTO crypto_assets (symbol, name, market_cap_rank, is_active) VALUES
('BTC', 'Bitcoin', 1, true),
('ETH', 'Ethereum', 2, true),
('USDT', 'Tether', 3, true),
('BNB', 'BNB', 4, true),
('SOL', 'Solana', 5, true),
('XRP', 'Ripple', 6, true),
('STETH', 'Staked Ethereum', 7, true),
('ADA', 'Cardano', 8, true),
('DOGE', 'Dogecoin', 9, true),
('AVAX', 'Avalanche', 10, true),
('LINK', 'Chainlink', 11, true),
('XLM', 'Stellar', 12, true),
('MATIC', 'Polygon', 13, true),
('UNI', 'Uniswap', 14, true),
('LTC', 'Litecoin', 15, true),
('BCH', 'Bitcoin Cash', 16, true),
('NOT', 'Notcoin', 17, true),
('ATOM', 'Cosmos', 18, true),
('NEAR', 'NEAR Protocol', 19, true),
('ICP', 'Internet Computer', 20, true),
('PEPE', 'Pepe', 21, true),
('CRO', 'Crypto.com Coin', 22, true),
('DOT', 'Polkadot', 23, true),
('SHIB', 'Shiba Inu', 24, true),
('ARKM', 'Arkham', 25, true),
('TRX', 'TRON', 26, true),
('USDC', 'USDC', 27, true),
('HBAR', 'Hedera', 28, true),
('VET', 'VeChain', 29, true),
('TON', 'Ton', 30, true),
('SUI', 'Sui', 31, true),
('FIL', 'Filecoin', 32, true),
('TAO', 'Bittensor', 33, true),
('OKB', 'OKB', 34, true),
('INJ', 'Injective', 35, true),
('ETC', 'Ethereum Classic', 36, true),
('MNT', 'Mantle', 37, true),
('ALGO', 'Algorand', 38, true),
('ARB', 'Arbitrum', 39, true),
('GALA', 'Gala', 40, true)
ON CONFLICT (symbol) DO NOTHING;

-- ============================================================================
-- UPDATE TIMESTAMP FIELDS WITH DEFAULTS
-- ============================================================================

UPDATE crypto_assets 
SET price_usd = CASE 
  WHEN symbol = 'BTC' THEN 97500.00000000
  WHEN symbol = 'ETH' THEN 3650.50000000
  WHEN symbol = 'SOL' THEN 210.45000000
  WHEN symbol = 'XLM' THEN 0.42500000
  WHEN symbol = 'USDC' THEN 1.00000000
  ELSE 0.01000000
END,
percent_change_24h = (RANDOM() * 10 - 5)::numeric(10, 4),
price_updated_at = NOW()
WHERE is_active = true;
