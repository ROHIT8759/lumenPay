-- ============================================================================
-- FINTECH EXTENSIONS - KYC, Stocks, Loans
-- Migration: 004_fintech_extensions
-- ============================================================================

-- ============================================================================
-- 1. INVESTMENTS (Stock/ETF Positions)
-- ============================================================================
create table if not exists public.investments (
  id uuid default uuid_generate_v4() primary key,
  wallet_address text not null,
  symbol text not null,
  asset_type text not null check (asset_type in ('STOCK', 'ETF', 'CRYPTO_STOCK')),
  amount_invested numeric not null check (amount_invested > 0),
  units numeric not null,
  price_at_buy numeric not null,
  status text default 'OPEN' check (status in ('OPEN', 'CLOSED')),
  created_at timestamp with time zone default timezone('utc'::text, now()),
  closed_at timestamp with time zone,
  close_price numeric,
  pnl numeric
);

create index if not exists idx_investments_wallet on public.investments(wallet_address);
create index if not exists idx_investments_status on public.investments(status);
create index if not exists idx_investments_symbol on public.investments(symbol);

alter table public.investments enable row level security;

-- RLS: Users can view their own investments
create policy "Users can view own investments"
  on public.investments
  for select
  using (true); -- Public read for demo; in production, add wallet verification

-- ============================================================================
-- 2. KYC SUBMISSIONS (Extended KYC with Levels)
-- ============================================================================
create table if not exists public.kyc_submissions (
  id uuid default uuid_generate_v4() primary key,
  wallet_address text not null unique,
  full_name text not null,
  dob date not null,
  country text not null,
  document_type text not null check (document_type in ('PAN', 'AADHAAR', 'PASSPORT', 'DRIVERS_LICENSE', 'NATIONAL_ID')),
  document_number text not null,
  kyc_level text default 'KYC_0' check (kyc_level in ('KYC_0', 'KYC_1', 'KYC_2')),
  status text default 'PENDING' check (status in ('PENDING', 'VERIFIED', 'REJECTED')),
  rejection_reason text,
  created_at timestamp with time zone default timezone('utc'::text, now()),
  verified_at timestamp with time zone,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

create index if not exists idx_kyc_wallet on public.kyc_submissions(wallet_address);
create index if not exists idx_kyc_status on public.kyc_submissions(status);

alter table public.kyc_submissions enable row level security;

create policy "Users can view own KYC submission"
  on public.kyc_submissions
  for select
  using (true);

-- ============================================================================
-- 3. COLLATERALIZED LOANS (Crypto-Backed Lending)
-- ============================================================================
create table if not exists public.collateralized_loans (
  id uuid default uuid_generate_v4() primary key,
  borrower_wallet text not null,
  collateral_asset text not null check (collateral_asset in ('USDC', 'XLM')),
  collateral_amount numeric not null check (collateral_amount > 0),
  loan_amount numeric not null check (loan_amount > 0),
  loan_asset text default 'USDC',
  interest_rate numeric not null, -- Annual percentage (e.g., 12.5)
  duration_days int not null check (duration_days > 0),
  status text default 'ACTIVE' check (status in ('PENDING', 'ACTIVE', 'REPAID', 'DEFAULTED', 'LIQUIDATED')),
  escrow_tx_hash text,
  contract_address text,
  created_at timestamp with time zone default timezone('utc'::text, now()),
  due_date timestamp with time zone,
  repaid_at timestamp with time zone,
  repayment_tx_hash text,
  liquidation_tx_hash text,
  total_repayment_amount numeric -- Principal + interest
);

create index if not exists idx_loans_borrower on public.collateralized_loans(borrower_wallet);
create index if not exists idx_loans_status on public.collateralized_loans(status);
create index if not exists idx_loans_due_date on public.collateralized_loans(due_date);

alter table public.collateralized_loans enable row level security;

create policy "Users can view own loans"
  on public.collateralized_loans
  for select
  using (true);

-- ============================================================================
-- 4. BLOCKCHAIN EVENTS (Event Indexer)
-- ============================================================================
create table if not exists public.blockchain_events (
  id uuid default uuid_generate_v4() primary key,
  event_type text not null,
  tx_hash text not null,
  ledger_sequence bigint,
  contract_address text,
  source_address text,
  destination_address text,
  amount numeric,
  asset_code text,
  data jsonb default '{}',
  processed boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

create index if not exists idx_events_type on public.blockchain_events(event_type);
create index if not exists idx_events_tx_hash on public.blockchain_events(tx_hash);
create index if not exists idx_events_processed on public.blockchain_events(processed);
create index if not exists idx_events_created on public.blockchain_events(created_at);

alter table public.blockchain_events enable row level security;

-- Admin only
create policy "Events are viewable"
  on public.blockchain_events
  for select
  using (true);

-- ============================================================================
-- 5. STOCK PRICE CACHE (Optional - for rate limiting)
-- ============================================================================
create table if not exists public.stock_price_cache (
  symbol text primary key,
  price numeric not null,
  change numeric,
  change_percent numeric,
  high numeric,
  low numeric,
  volume bigint,
  last_updated timestamp with time zone default timezone('utc'::text, now())
);

-- ============================================================================
-- 6. ADMIN OVERRIDES (Demo Controls)
-- ============================================================================
create table if not exists public.admin_overrides (
  id uuid default uuid_generate_v4() primary key,
  override_type text not null check (override_type in ('PRICE', 'KYC', 'LOAN_STATUS')),
  target_id text not null, -- Symbol, wallet, or loan_id
  override_value jsonb not null,
  active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()),
  expires_at timestamp with time zone
);

create index if not exists idx_overrides_type on public.admin_overrides(override_type);
create index if not exists idx_overrides_target on public.admin_overrides(target_id);

-- ============================================================================
-- END OF MIGRATION
-- ============================================================================
