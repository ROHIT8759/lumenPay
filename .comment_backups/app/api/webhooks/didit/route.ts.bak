/**
 * Didit Webhook Handler
 * 
 * POST /api/webhooks/didit
 * Receives webhook events from Didit when biometric verification completes
 */

import { NextRequest, NextResponse } from 'next/server';
import { diditService, DiditWebhookPayload } from '@/lib/diditService';

/**
 * POST /webhooks/didit
 * 
 * Webhook payload from Didit:
 * {
 *   session_id: string,
 *   vendor_data: string (wallet_address),
 *   status: 'approved' | 'rejected' | 'expired',
 *   confidence_score?: number,
 *   timestamp: string
 * }
 */
export async function POST(request: NextRequest) {
    try {
        // Get raw body for signature verification
        const rawBody = await request.text();
        const signature = request.headers.get('x-didit-signature') || '';

        // Verify webhook signature (HMAC)
        const isValid = diditService.verifyWebhookSignature(rawBody, signature);

        if (!isValid) {
            console.warn('[Webhook/Didit] Invalid signature');
            // In development/hackathon, we might want to process anyway
            if (process.env.NODE_ENV === 'production') {
                return NextResponse.json(
                    { success: false, error: 'Invalid signature' },
                    { status: 401 }
                );
            }
        }

        // Parse the payload
        let payload: DiditWebhookPayload;
        try {
            payload = JSON.parse(rawBody);
        } catch {
            return NextResponse.json(
                { success: false, error: 'Invalid JSON payload' },
                { status: 400 }
            );
        }

        // Validate required fields
        if (!payload.session_id || !payload.vendor_data || !payload.status) {
            return NextResponse.json(
                { success: false, error: 'Missing required fields' },
                { status: 400 }
            );
        }

        // Process the webhook event
        const result = await diditService.processWebhookEvent(payload);

        if (!result.success) {
            return NextResponse.json(
                { success: false, error: result.error },
                { status: 500 }
            );
        }

        // Return success - Didit expects 200 OK
        return NextResponse.json({ success: true });

    } catch (error: unknown) {
        const errorMessage = error instanceof Error ? error.message : 'Unknown error';
        console.error('[Webhook/Didit] Error:', errorMessage);
        return NextResponse.json(
            { success: false, error: errorMessage },
            { status: 500 }
        );
    }
}

/**
 * GET /webhooks/didit
 * Health check endpoint for webhook configuration
 */
export async function GET() {
    return NextResponse.json({
        status: 'ok',
        service: 'didit-webhook',
        timestamp: new Date().toISOString()
    });
}
