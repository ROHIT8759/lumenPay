/**
 * Wallet Auth - Verify Signature Endpoint
 * 
 * POST /api/wallet/auth/verify
 * 
 * Verifies a signed nonce and issues a JWT for authenticated requests.
 * This enables "Sign In with Stellar Wallet" without email/password.
 */

import { NextRequest, NextResponse } from 'next/server';
import { Keypair } from '@stellar/stellar-sdk';
import { SignJWT } from 'jose';
import { validateAndConsumeNonce } from '@/lib/nonceStore';
import { supabase } from '@/lib/supabaseClient';

const JWT_SECRET = new TextEncoder().encode(
    process.env.JWT_SECRET || 'lumenpay-jwt-secret-change-in-production'
);

export async function POST(request: NextRequest) {
    try {
        const body = await request.json();
        const { publicKey, signature, nonce } = body;

        // Validate required fields
        if (!publicKey || !signature || !nonce) {
            return NextResponse.json(
                { error: 'Missing required fields' },
                { status: 400 }
            );
        }

        // Validate nonce from shared store
        const nonceResult = validateAndConsumeNonce(publicKey, nonce);
        if (!nonceResult.valid) {
            return NextResponse.json(
                { error: nonceResult.error },
                { status: 401 }
            );
        }

        // Verify the signature
        try {
            const keypair = Keypair.fromPublicKey(publicKey);
            const messageBuffer = Buffer.from(nonce, 'utf8');
            const signatureBuffer = Buffer.from(signature, 'base64');

            const isValid = keypair.verify(messageBuffer, signatureBuffer);

            if (!isValid) {
                return NextResponse.json(
                    { error: 'Invalid signature' },
                    { status: 401 }
                );
            }
        } catch (error) {
            return NextResponse.json(
                { error: 'Signature verification failed' },
                { status: 401 }
            );
        }

        // Ensure user exists in database (create if not)
        await ensureUserExists(publicKey);

        // Generate JWT token
        const token = await new SignJWT({
            address: publicKey,
            type: 'wallet',
        })
            .setProtectedHeader({ alg: 'HS256' })
            .setIssuedAt()
            .setExpirationTime('24h')
            .sign(JWT_SECRET);

        return NextResponse.json({
            token,
            user: {
                address: publicKey,
            },
        });
    } catch (error: any) {
        console.error('Verification error:', error);
        return NextResponse.json(
            { error: 'Verification failed' },
            { status: 500 }
        );
    }
}

/**
 * Ensure user exists in database
 * Creates profile and wallet record if they don't exist
 */
async function ensureUserExists(publicKey: string): Promise<void> {
    try {
        // Check if wallet exists
        const { data: existingWallet } = await supabase
            .from('wallets')
            .select('id')
            .eq('public_key', publicKey)
            .single();

        if (existingWallet) {
            return; // User already exists
        }

        // Create profile with wallet address as ID
        const { error: profileError } = await supabase
            .from('profiles')
            .upsert({
                id: publicKey,
                email: `${publicKey.substring(0, 8)}@lumenpay.wallet`,
                full_name: `Wallet ${publicKey.substring(0, 8)}`,
                kyc_status: 'pending',
            }, { onConflict: 'id' });

        if (profileError) {
            console.warn('Profile upsert warning:', profileError);
        }

        // Create wallet record (public key only - no secret!)
        const { error: walletError } = await supabase
            .from('wallets')
            .upsert({
                user_id: publicKey,
                public_key: publicKey,
                wallet_type: 'external', // Non-custodial
                network: 'testnet',
            }, { onConflict: 'public_key' });

        if (walletError) {
            console.warn('Wallet upsert warning:', walletError);
        }

    } catch (error) {
        console.error('Error ensuring user exists:', error);
        // Don't throw - auth should still succeed
    }
}
